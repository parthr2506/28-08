<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Posts</title>
    <style>
        body {
            font-family: sans-serif;
        }

        .post-card {
            border: 1px solid #ccc;
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 8px;
        }
    </style>
</head>

<body>
    <h1>All Posts</h1>
    <a href="create-post.html" class="create-button">Create New Post</a>

    <div id="posts-container">
        <p>Loading posts...</p>
    </div>

    <script>
        async function fetchAllPosts() {
            try {
                const response = await fetch('http://localhost:5500/api/post/get');
                if (!response.ok) {
                    throw new Error('Failed to fetch posts');
                }
                const posts = await response.json();
                const postsContainer = document.getElementById('posts-container');
                postsContainer.innerHTML = '';

                posts.forEach(post => {
                    const postElement = document.createElement('div');
                    postElement.className = 'post-card';
                    postElement.innerHTML = `
                        <h3>${post.title}</h3>
                        <p>${post.body}</p>
                        <small>Author: ${post.authorId}</small>
                        <div>
                            <button onclick="updatePost('${post.id}')">Edit</button>
                            <button onclick="deletePost('${post.id}')">Delete</button>
                        </div>
                    `;
                    postsContainer.appendChild(postElement);
                });
            } catch (error) {
                console.error('Error fetching posts:', error);
                document.getElementById('posts-container').innerHTML = '<p>Error loading posts.</p>';
            }
        }

        async function updatePost(id) {
            const newTitle = prompt("Enter new title:");
            const newBody = prompt("Enter new body:");
            console.log("Attempting to update post with ID:", id);
            console.log("New Title:", newTitle);
            console.log("New Body:", newBody);
            if (!newTitle || !newBody) return;

            try {
                const response = await fetch(`http://localhost:5500/api/post/update/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: newTitle, body: newBody })
                });
                const result = await response.json();
                console.log("Update request finished. Response status:", response.status);
                console.log("Response data:", result);

                if (response.ok) {
                    await fetchAllPosts();
                    alert('Post updated successfully!');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update post');
                }
            } catch (error) {
                console.error('Error updating post:', error);
                alert(`Error updating post: ${error.message}`);
            }
        }

        async function deletePost(id) {
            if (confirm("Are you sure you want to delete this post?")) {
                try {
                    const response = await fetch(`http://localhost:5500/api/post/delete/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        alert('Post deleted successfully!');
                        fetchAllPosts();
                    } else {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to delete post');
                    }
                } catch (error) {
                    console.error('Error deleting post:', error);
                    alert(`Error deleting post: ${error.message}`);
                }
            }
        }

        document.addEventListener('DOMContentLoaded', fetchAllPosts);
    </script>
</body>

</html>